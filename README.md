# Техническое описание
 
# Общие сведения и предпосылки

С 2013 года я занимаюсь изучением вопроса возможного предсказания рынка валют и теперь крипто активов.
Из многочисленных исследований и собственных наблюдений можно сделать несколько выводов а крипторынке
1.	Рынок на больших таймфремах скорее вероятностно предопределенный, чем хаотичный.
2.	Рынок в большей степени зависит от решений маркет мейкеров чем от игроков в стакане цен (исследование группы Protos https://protos.com/tether-papers-crypto-stablecoin-usdt-investigation-analysis/ показало, что до 93% всей ликвидности на биржах принадлежат двум компаниям и только 2-3% игрокам, остальное институционалам) 
3.	Маркетмейкеры являются основными бенефициарами разгона и падения рынков, но и они пользуются годовой сезонностью для усиления эффекта. Годовая сезонность связана с вливанием свободных средств граждан всех стран с целью обогатится или получить опыт на свободных «лишних» деньгах. Как правило рост рынков совпадает с периодом выплат премий по двум финансовым отчетным периодом крупнейших компаний, конец третьего квартала и подведение итогов фин года – период первого квартала. В эти периоды менеджемент максимально лоялен риску и начинает инвестиции полученными свободными средствами.
4.	Собственные наработки моделей предсказаний используя технический анализ и инструмент от google TensorFlow на 10 летней истории Bitcoin позволили получить превосходные результаты на периоде известном нейронке и бесполезные для нового периода. Сравнить это можно с тем, как если бы мы учили нейронку переводу слов, с чем нейронка прекрасно справляется, т.е. переводить те же слова и выражения, которыми мы пользуемся сейчас для нее не проблема, но если бы буквы, слова, выражения менялись каждый день (энропия) , нейронка не смогла бы в достаточной степени вероятности делать правильный перевод, так как меняются правила слишком быстро и не заметно для нейронки.
5.	Использование OnChain данных с желанием найти предикторы движения цены, например приток средст на биржи, кол-во новых монет, новых кошельков, активности в сети так же не дали результатов. Так как скорее всего большинство людей сначала видят движение цены, а потом активизируются в Твиттерах, в депозитах и прочих следах активности.
6.	Однако у рынка есть свои законы, знания о них могут помочь в создании доходной модели алгоритмичной торговли. Так, например рынок четко положительно реагирует на периоды квартальных премий, которые приходятся на конец третьего квартала и годовых премий период первого квартала. И отрицательно на период летних отпусков, когда люди предпочитают тратить средства на отпуска, а не на инвестиции. Другими словами, у рынков есть ярко выраженная сезонность.
7.	Рынок на малых таймфремах – это шум.

# Три силы рынка, как основы сеточной торговой модели
1.	Маркет мейкер
2.	Сезонность
3.	Новости проекта

В задачи маркет мейкера входит либо поддерживать стабильность цены, как это делает ЦБ у Государства, или операторы – владельцы stable coins (USDC, USDT, BUSD, PAX, TERRA и прочие) либо наоборот, формировать волну волатильности эмитируя у участников ощущения предсказуемости поведения рынка, например по анализу средних скользящих, уровней поддержки, сопротивления и кучи других якобы гарантирующих закономерности поведения цены. Все это для того, чтобы возникло желание играть и выигрывать у трейдеров- спекулянтов.
Зарабатывает же маркет мейкер на спреде и вознаграждения от биржи за предоставленные объемы в пулы ликвидности. Так например, маркетмейкер только очень не большой объем продаст за минимальный спред, если входить по рынку большим ордером, будет проскальзывание которое и формирует представление о реальном спреде и понимание сколько маркет мейкер заработает за такую сделку, достаточно продать по рынку и тут же купить по рынку на 1 млн долларов крипто актива, остаток и укажет на то, сколько ушло на комиссию и сколько заработал маркет мейкер.
В обычном мире чем больше ты покупаешь, тем больше скидка, и выгодней цена. На бирже все, наоборот, чем больше ты покупаешь, тем выше цена.
# Риски у маркет мейкеров.
Маркет мейкер тоже рискует, например есть технические сбои на бирже и маркет мейкер может потерять так же при задержках исполнения ордера биржей. Были случаи, когда BIFINEX ставил в очередь на десятки минут на исполнение лимитных и рыночных ордеров.
Маркет мейкеру так же приходится учитывать сезонность, действия арбитражников (высокочастотная торговля) и прочие нюансы в своей работе. Одной из проблем маркет мейкеров на спотовом рынке, это то, что они одновременно в наличии должны держать обе валюты и заработок должен покрывать разницу в падении стоимости криптовалюты. Поэтому этот риск они научились передавать тем же пользователям создав пулы ликвидности. Теперь маркет мейкеры просто делятся с поставщиком ликвидности частью спреда и экономией на комиссии, оставляя риски падения стоимости актива у инвестора.
Однако это не убирает требования у маркет мейкера управлять ликвидностью, и периодически перекладывать её в парах из левой стороны пары в правую то покупая, то продавая BTC например. Так как стакан должен быть уравновешен.
Для этого маркер делает такие перевороты в лучшей для него цене. Продает дорого и много перед разворотом вниз, закупает дёшево перед разворотом вверх. Однако маркет мейкеру для переворота своих активов нужен объем от пользователей, чтобы не покупать у самого себя. Поэтому чаще всего на положительных новостях проекта и общем медвежьем тренде маркет мейкер поставит барьерный уровень продав максимально своей ликвидности, не дав цене высоко подняться, а потом заставит тех, кто вошёл выйти, двинув цену в зону Stop Loss и таким образом получит еще ликвидности и убытки игроков себе в карман.
Так как невозможно предсказать действия маркет мейкера в моменте мы должны исходить из того, что волатильностью, которую он создает, управлять мы сможем только усреднением. Для этого предлагается использовать сеточную торговлю.
# Пример и принцип сеточного торговли

Сеточная торговля подразумевает торговлю используя гипотезу, что цена возвращается и не ходит только вверх или только вниз, у цены есть корректировки и это даёт возможность фиксировать прибыль.

![image](https://user-images.githubusercontent.com/30444197/168464191-64eb5ee0-9a82-4021-a701-be61df1f744b.png)
 

# Проблемы сеточной торговли
 
Как и у маркет мейкера у сеточной торговли ещё больше проблем.
Во-первых, у обычного трейдера недостаточно ликвидности для удержания баланса 50/50 в долгую.
Например, если трейдер начал был торговать в конце 2017 года, то сравнительно скоро трейдер своей сеткой купил падающий биткойн и два года ждал бы восстановления. Поэтому важно:
1.	следить за трендом, и не работать «контр-трендово» т.е. против тренда 
2.	Новости и паника, это угроза для сеточной торговли, поэтому важно"убирать" сетку при аномальном однобоком (без корректировок) быстром движении на рынке (принцип безопасной циркулярной пилы https://www.youtube.com/watch?v=Pi2YuNkXpAU)
3.	Расширять шаг сетки в зависимости от волатильности.
4.	Время от времени фиксировать убытки и закрывать открытые ордера при прогнозе разворота тренда.
5.	Перестраивать сетку после получения нового прогноза (настраиваемый параметр, по-умолчанию каждый час).
6.	Увеличивать объемы сделок при нарастании не закрытых ордеров (адаптивный мартингейл)
7.	Минимизировать риски п. 6 работать только по тренду.
# Что необходимо сделать? Техническое задание  
(V)- выполнено  
(-) не выполнено  
  
1.	Создать код по скачиванию временных рядов цены с достоверными данными, тиковой(-), минутной часовой и дневной истории. (V)
2.	Создать пополняемую базу данных для тестирования будущего алгоритма (-)
3.	Создать модуль прогнозирования тренда и прогноза средней, верхней и нижней цены канала. Используя Facebook Prophet https://facebook.github.io/prophet/ (V)
4.	Создать модуль авто-оптимизации прогноза. (V)
5.	Создать модуль формирования сетки из расчета п3, а также из оценки волатильности для расчета шага, оценки маржи для расчета объема и кол-ва лотов в сетке. (пример 3commas.com grid bot) (-)
6.	Создать модуль управления рисками. Отменять сетку при аномалиях на рынке. Увеличивать шаг. Менять направленность ордеров в сторону тренда. (-)
7.	Создать модуль API 3commas.com для работы алгоритма с биржей (V)
8.	Создать интерфейс Backtest для тестирования стратегии с учетом спреда комиссий и проскальзывания. (-)
9.	Создать визуализацию тестирования работы бота на тиковой и минутной истории (-)
  
# Примеры ситуаций на рынке и ожидаемая работа алгоритмов
  
![image](https://user-images.githubusercontent.com/30444197/168474708-b7348fe2-a807-4e66-ada2-eb6e287bd728.png)

  
Стандартный шаг Take profit для каждого инструмента ставим вручную, шаг сетки так же, стандартный ставим вручную, но:
1.	Если растущий тренд, то формируем сетку BUY ниже действующей цены и ниже прогнозной средней цены. 
Шаг Take Profit увеличивается на стандартный шаг * (1+ коэффициент прогноз увеличения цены следующего дня). При этом сетка отложенных ордеров на покупку, сжимается по условию шаг сетки = шаг стандартный * (1- коэффициент роста увеличения цены) 
При растущем тренде, но при всплеске цены выше прогнозной верхней цены коридора, шортим сеткой выше коридора. 
![image](https://user-images.githubusercontent.com/30444197/168474738-c5505f6f-bbba-4dc3-9824-52d5b72e639f.png)

  
               
2.	В обратном порядке если прогнозируется падающий тренд. 
При падающим тренде, но выходе цены за пределы прогнозной нижней цены, строим лонг сетку ниже коридора.
![image](https://user-images.githubusercontent.com/30444197/168474779-17574c08-fee9-4673-a459-42fcb205475e.png)

  
3. Предполагаемый индикатор оценки риска волатильности рынка для выбора трех режимов работы сетки
Если текущее значение истинного диапазона соответствует средней волатильности, основная масса сделок заключается по базовой стратегии, работаем по тренду, как в предыдущих рисунках
  
Если же ATR находится в области низкой активности, целесообразно уменьшать шаг сетки и работать в обе стороны при условном флете, поскольку на крупных таймфреймах заработок станет значительно меньше привычных величин.
  
И последнее состояние рынка характеризуется высокой волатильностью. Отводим сетку от действующей цены на безопасный диапазон, или вообще выключаем, ожидая стабилизации рынка.
![image](https://user-images.githubusercontent.com/30444197/168466116-6933f286-59bc-4ba9-a384-93d78563579a.png)

  
# Установка и настройка Prophet Grid Bot
  
Зависимости:
•	Python 3.7.x (так как Prophet от FB не встанет на более современные версии)  
•	apprise==0.9.7  
•	beautifulsoup4==4.11.1  
•	ciso8601==2.2.0  
•	pandas==1.3.0  
•	plotly==5.6.0  
•	prophet==1.0.1  
•	py3cw==0.0.36  
•	requests==2.27.1  
•	san==1.2.0  
•	sanpy==0.9.1  
•	scikit_learn==1.1.0  
  


# Настроить API и аккаунт в 3commas.com
https://3commas.io/ru/api_access_tokens
  
# Запуск Скрипта
После первого запуска Скрипта создается _gridbot.ini
  
# Настроить _gridbot.ini
  
[settings]  
timezone = Europe/Amsterdam  
timeinterval = 3600 #интервал обновления  
debug = False  
logrotate = 7  
botids = [13215**]  
mode = trade # trade - если реальная торговля и redbag для тестрирования  
3c-apikey = *****9a595349ddb2fb6429484ee51dfcf7cbeb2c3c41a2bbf8bacdc2bc2047  
3c-apisecret = *************------------------------------*****************  
notifications = False  
notify-urls = ['notify-url1', 'notify-url2']  
  
#Поддержка  
Возникли проблемы? Свяжитесь со мной, я постараюсь помочь, насколько смогу.  
Автор / Контакт  
Dmitry Nazarov  
Контакт Telegram: https://t.me/demetrius_i  
![image](https://user-images.githubusercontent.com/30444197/168467157-cd09d7e0-68bf-44b1-9f57-08fcbcbbf324.png)

